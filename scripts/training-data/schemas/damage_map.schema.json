{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "damage_map.schema.json",
  "title": "Damage Map (06f)",
  "type": "object",
  "required": [
    "video_id",
    "generated_at",
    "pipeline_version",
    "source_file",
    "input",
    "damage_type_enum",
    "known_stage07_drop_reasons",
    "segments",
    "conversation_summaries",
    "dropped_candidate_trace",
    "summary"
  ],
  "additionalProperties": false,
  "properties": {
    "video_id": { "type": "string", "pattern": "^[A-Za-z0-9_-]{11}$" },
    "generated_at": { "type": "string" },
    "pipeline_version": { "type": "string" },
    "source_file": { "type": "string" },
    "input": {
      "type": "object",
      "required": ["stage06d", "stage07"],
      "additionalProperties": false,
      "properties": {
        "stage06d": { "type": "string" },
        "stage07": { "type": ["string", "null"] }
      }
    },
    "damage_type_enum": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "transcript_artifact",
          "low_quality",
          "mixed_mode",
          "speaker_ambiguity",
          "boundary_uncertain"
        ]
      }
    },
    "known_stage07_drop_reasons": {
      "type": "array",
      "items": { "type": "string" }
    },
    "segments": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "segment_id",
          "conversation_id",
          "damage_types",
          "damage_reason_codes",
          "severity",
          "seed_confidence",
          "contamination_window"
        ],
        "additionalProperties": false,
        "properties": {
          "segment_id": { "type": "integer" },
          "conversation_id": { "type": "integer" },
          "damage_types": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": [
                "transcript_artifact",
                "low_quality",
                "mixed_mode",
                "speaker_ambiguity",
                "boundary_uncertain"
              ]
            }
          },
          "damage_reason_codes": {
            "type": "array",
            "items": { "type": "string" }
          },
          "severity": { "type": "string", "enum": ["low", "medium", "high"] },
          "seed_confidence": { "type": "number", "minimum": 0, "maximum": 1 },
          "contamination_window": {
            "type": "object",
            "required": ["start_segment_id", "end_segment_id"],
            "additionalProperties": false,
            "properties": {
              "start_segment_id": { "type": "integer" },
              "end_segment_id": { "type": "integer" }
            }
          },
          "details": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      }
    },
    "conversation_summaries": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "conversation_id",
          "segment_count",
          "damaged_segment_count",
          "damaged_segment_ratio",
          "token_count",
          "damaged_token_count",
          "damaged_token_ratio",
          "high_severity_seed_count",
          "damaged_segment_ids"
        ],
        "additionalProperties": false,
        "properties": {
          "conversation_id": { "type": "integer", "minimum": 1 },
          "segment_count": { "type": "integer", "minimum": 0 },
          "damaged_segment_count": { "type": "integer", "minimum": 0 },
          "damaged_segment_ratio": { "type": "number", "minimum": 0, "maximum": 1 },
          "token_count": { "type": "integer", "minimum": 0 },
          "damaged_token_count": { "type": "integer", "minimum": 0 },
          "damaged_token_ratio": { "type": "number", "minimum": 0, "maximum": 1 },
          "high_severity_seed_count": { "type": "integer", "minimum": 0 },
          "damaged_segment_ids": { "type": "array", "items": { "type": "integer" } }
        }
      }
    },
    "dropped_candidate_trace": {
      "type": "object",
      "required": [
        "present",
        "dropped_candidates_total",
        "segment_drops_total",
        "segment_drops_traced",
        "segment_drops_untraced",
        "unknown_drop_reason_count",
        "unknown_drop_reason_samples",
        "untraced_segment_ids",
        "passes_trace_contract"
      ],
      "additionalProperties": false,
      "properties": {
        "present": { "type": "boolean" },
        "dropped_candidates_total": { "type": "integer", "minimum": 0 },
        "segment_drops_total": { "type": "integer", "minimum": 0 },
        "segment_drops_traced": { "type": "integer", "minimum": 0 },
        "segment_drops_untraced": { "type": "integer", "minimum": 0 },
        "unknown_drop_reason_count": { "type": "integer", "minimum": 0 },
        "unknown_drop_reason_samples": {
          "type": "array",
          "items": { "type": "string" }
        },
        "untraced_segment_ids": {
          "type": "array",
          "items": { "type": "integer" }
        },
        "passes_trace_contract": { "type": "boolean" }
      }
    },
    "summary": {
      "type": "object",
      "required": [
        "segments_total",
        "damaged_segments_total",
        "damage_type_counts",
        "severity_counts",
        "conversation_count",
        "trace_contract_passed"
      ],
      "additionalProperties": false,
      "properties": {
        "segments_total": { "type": "integer", "minimum": 0 },
        "damaged_segments_total": { "type": "integer", "minimum": 0 },
        "damage_type_counts": {
          "type": "object",
          "additionalProperties": { "type": "integer", "minimum": 0 }
        },
        "severity_counts": {
          "type": "object",
          "additionalProperties": { "type": "integer", "minimum": 0 }
        },
        "conversation_count": { "type": "integer", "minimum": 0 },
        "trace_contract_passed": { "type": "boolean" }
      }
    }
  }
}
