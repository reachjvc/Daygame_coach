QUALITY IS THE ONLY PRIORITY. There is no deadline. Spend whatever time
and tokens it takes to get this right. A clean, correctly-attributed,
well-structured RAG corpus produces better answers than a large noisy one.
Never trade quality for speed. Never lower gates to "get content flowing."

   YouTube URLs (docs/pipeline/sources.txt)
             |
             v
+--------------------------+
|    01.EXT. DOWNLOAD      |    yt-dlp
|  Download audio from YT  |    Rate-limited, backoff
+--------------------------+
             |
             |  data/01.download/<source>/<video>/*.wav
             v
+--------------------------+
|   02.EXT. TRANSCRIBE     |    Whisper large-v3
|  Speech-to-text (raw)    |    Hallucination prevention
+--------------------------+
             |
             |  data/02.EXT.transcribe/.../*.full.json
             v
+--------------------------+
|     03.EXT. ALIGN        |    WhisperX
|  Sentence-level timing   |    Better word boundaries
+--------------------------+
             |
             |  data/03.EXT.align/.../*.full.json
             v
+--------------------------+
|    04.EXT. DIARIZE       |    pyannote
|  Who said what           |    SPEAKER_00, SPEAKER_01...
|  (speaker labels)        |    Can misassign speakers
+--------------------------+
             |
             |  data/04.EXT.diarize/.../*.full.json
             v
+--------------------------+
| 05.EXT. AUDIO FEATURES   |    librosa / pyannote
|  Pitch, energy, tempo,   |    Speaker embeddings
|  spectral brightness     |
+--------------------------+
             |
             |  data/05.EXT.audio-features/.../*.audio_features.json
             v
+============================================+
|         LLM STAGES (Claude CLI)            |
+============================================+
             |
             v
+--------------------------+
|  06.LLM. VIDEO TYPE +    |    1 LLM call / video
|      CONVERSATIONS       |
|                          |    Reads ALL segments
|  Classify video:         |
|   - infield              |    Speaker roles:
|   - talking_head         |    SPEAKER_XX -> coach,
|   - podcast              |    target, voiceover, other
|   - compilation          |
|                          |    Conversation boundaries:
|  Speaker role assignment |    approach, commentary,
|  + boundary detection    |    transition
|  in single pass          |    conversation_id: 1,2,3...
|                          |
|  Transcript quality:     |    transcript_confidence:
|   LLM assesses overall   |    score: 1-100
|   transcript coherence   |    reasoning: "..."
|                          |
|  Teaser detection:       |    is_teaser: true
|   Identifies intro       |    teaser_of_conversation_id
|   previews that repeat   |    Stage 09 skips these
|   later in video         |
|                          |
|  Also fixes diarization  |    Catches pyannote errors
|  errors using context    |    via semantic understanding
+--------------------------+
             |
             |  data/06.LLM.video-type/.../*.conversations.json
             v
+--------------------------+
|  06b.LLM. VERIFY         |    1 LLM call / video
|                          |    Claude CLI
|  5-pass critical review  |
|  of Stage 06 output:     |    APPROVE / FLAG / REJECT
|   - Role coherence       |    verdict per video
|   - Conversation bounds  |
|   - Commentary verify    |    Halts pipeline
|   - Collapsed speakers   |    on REJECT
|   - Structural coherence |
+--------------------------+
             |
             |  data/06b.LLM.verify/.../*.verification.json
             v
+--------------------------+
|  06c.DET. PATCH          |    No LLM — pure JSON
|                          |    transform
|  Auto-applies from 06b:  |
|   - Misattributions      |    conf ≥ 0.70
|   - Collapse issues      |    conf ≥ 0.70
|   - Video type fixes     |    conf ≥ 0.85
|   - Boundary fixes:      |    conf ≥ 0.90
|     merge_with_next      |
|     merge_with_previous  |    APPROVE: copy unchanged
|     split_at_segment_N   |    FLAG: apply fixes
|                          |    REJECT: blocked by 06b
|  Flags but won't fix:    |
|   - other_flags          |    Adds patch_metadata
+--------------------------+
             |
             |  data/06c.DET.patched/.../*.conversations.json
             v
+--------------------------+
|  06d.DET. SANITIZE       |    No LLM — deterministic
|                          |
|  Sanitization layer:     |    Deterministic cleanup
|  evidence allowlists,    |    after 06b/06c fixes
|  stage07 evidence IDs    |
+--------------------------+
             |
             |  data/06d.DET.sanitized/.../*.conversations.json
             v
+--------------------------+
|  06e.LLM. QUALITY-CHECK  |    1 LLM call / video
|                          |    Claude CLI
|  Focused transcript      |
|  quality assessment:     |    ASR artifact detection
|   - word_repetition      |    damage_severity stamped
|   - nonsense             |    repair suggestions
|   - language_confusion   |
+--------------------------+
             |
             |  data/06e.LLM.quality-check/.../*.quality-check.json
             |          |
             v          v (quality seeds)
+--------------------------+
|  06f.DET. DAMAGE-MAP     |    No LLM — deterministic
|                          |
|  Builds damage map from  |    Reads 06d segments +
|  06d flags + 06e quality |    06e quality-check data
|  data:                   |
|   - transcript_artifact  |    Per-segment severity
|   - low_quality          |    + contamination windows
|   - mixed_mode           |
|   - speaker_ambiguity    |
|   - boundary_uncertain   |
+--------------------------+
             |
             |  data/06f.DET.damage-map/.../*.damage-map.json
             v
+--------------------------+
|  06g.LLM. DAMAGE-ADJUD.  |    N LLM calls / video
|                          |    Claude CLI
|  Per-seed adjudication:  |
|   - transcript_confidence|    Contamination spans
|   - speaker_confidence   |    Repair acceptance
|   - phase_confidence     |    Anchor eligibility
|   - repair_possible      |
+--------------------------+
             |
             |  data/06g.LLM.damage-adjudicator/.../*.damage-adjudication.json
             v
+--------------------------+
|  06h.DET. CONF-PROP.     |    No LLM — deterministic
|                          |
|  Propagates confidence   |    Reads 06g adjudications
|  scores from adjudicated |    Stamps per-segment
|  seeds to all segments   |    confidence scores
+--------------------------+
             |
             |  data/06h.DET.confidence-propagation/.../*.confidence.json
             v
+--------------------------+
|  07.LLM. CONTENT         |    1 LLM call / video
|  (enrichment only)       |    2 prompt variants:
|                          |
|  INFIELD/COMPILATION:    |
|   Per approach:          |    31 techniques taxonomy
|    - Techniques used     |    22 topics taxonomy
|    - Topics discussed    |
|    - Turn-by-turn phases |    open -> pre_hook ->
|    - Hook/investment     |    post_hook -> close
|   Per commentary block:  |
|    - Teaching points     |    Interleaved with
|    - Techniques discussed|    approaches by time
|                          |
|  TALKING_HEAD/PODCAST:   |
|   Per topic section:     |    LLM identifies section
|    - Techniques discussed|    boundaries from
|    - Topics covered      |    full transcript
|                          |
|  ALL: unlisted_concepts  |    Taxonomy gap detection
|   (techniques & topics   |    on every enrichment
|    not in taxonomy)      |
|                          |
|  Quality pass-through:   |    low_quality_segments +
|   from 06e, not LLM      |    transcript_artifacts
+--------------------------+
             |
             |  data/07.LLM.content/.../*.enriched.json
             v
+--------------------------+
| 08.DET. TAXONOMY VALID.  |    No LLM — pure aggregation
|                          |
|  QUALITY GATE            |    Reads all enriched JSON
|                          |    from data/07.LLM.content/
|  Validates taxonomy      |
|  coverage before prep    |    Exit code 0 = PASS
|                          |    Exit code 1 = FAIL
|  Blocks on high-freq     |
|  unlisted concepts       |    --threshold N (default 3)
|  (>= threshold)          |    --strict (any unlisted)
|                          |
|  Reports:                |    data/08.DET.taxonomy-validation/
|   - unlisted techniques  |    <label>.report.json
|   - unlisted topics      |
|   - recommendation       |
+--------------------------+
             |
             |  data/08.DET.taxonomy-validation/<label>.report.json
             |  (exits 1 if high-frequency unlisted found)
             v
+--------------------------+
|  09.EXT. CHUNK & EMBED   |    Ollama embeddings
|                          |    (no DB writes)
|  Transforms enriched     |
|  content into chunks     |    Outputs JSON files
|  with embeddings         |
|                          |
|  Approach chunks:        |    Hybrid phase-based:
|   Phase-based chunking   |    - merge tiny (<100 chars)
|   with metadata          |    - split huge (>2000 chars)
|                          |    segmentType=INTERACTION
|  Commentary chunks:      |    isRealExample=true
|   Simple text chunking   |
|   + video_type metadata  |    segmentType=COMMENTARY
|                          |    isRealExample=false
|  Parent references:      |
|   videoId (YouTube id)   |    Enables sibling fetch:
|   videoType, channel     |    "get full conversation"
|   conversationId         |
|                          |
|  Incremental: skips      |    Hash-based change
|  unchanged sources       |    detection
+--------------------------+
             |
             |  data/09.EXT.chunks/<source>/<video_id>.chunks.json
             |  data/09.EXT.chunks/.chunk_state.json
             v
+--------------------------+
|  10.EXT. INGEST          |    Supabase pgvector
|                          |    (DB writes only)
|  Reads chunk files       |
|  from Stage 09           |    Reads .chunks.json
|                          |
|  Inserts embeddings      |    deleteEmbeddingsBySource
|  into Supabase           |    storeEmbeddings
|                          |
|  Incremental: skips      |    Hash-based change
|  unchanged chunks        |    detection
+--------------------------+
             |
             v
     Supabase embeddings
       (vector store)
             |
             v
   RAG-powered Q&A chatbot


=== END GOAL: SMART RAG RETRIEVAL ===

Current: Vector similarity on dialogue text only.
Target:  Metadata-aware retrieval + query understanding.

+--------------------------+
|  QUERY TIME FLOW         |
|  (future enhancement)    |
|                          |
|  User question           |
|       ↓                  |
|  LLM query parsing       |    Extract intent:
|  "she studies medicine"  |    {topic: career,
|       ↓                  |     keyword: medicine}
|  Metadata filter         |    WHERE topics ? 'career'
|  + Vector search         |    AND content ~ 'medicine'
|       ↓                  |    ORDER BY similarity
|  Top chunks + metadata   |
|       ↓                  |
|  Claude sees:            |    [TECHNIQUE: qualification]
|  enriched context        |    [TOPIC: career]
+--------------------------+

REQUIRES (in order):
1. [ ] Wire metadata filters in retrieval.ts
2. [ ] Add query parsing (rules → LLM)
3. [ ] Re-embed with metadata prefix (Stage 09)
4. [ ] Show metadata to Claude in prompt

See: docs/pipeline/validation_harness.md
